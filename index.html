<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Entity Manager - Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; scroll-behavior: smooth; overflow-x: hidden; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); transition: all 0.3s ease; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .btn-primary { background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-ghost { color: #64748b; border: 1px solid #cbd5e1; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        .input-field { width: 100%; border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.375rem; margin-top: 0.25rem; }
        
        .filter-tag { cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; }
        .filter-tag.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* Modal Styles */
        #configModal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 1rem; padding: 2rem; position: relative; }

        /* Table Styles */
        .table-container { overflow-x: auto; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background-color: #f1f5f9; text-align: left; padding: 0.75rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        td { padding: 0.75rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }

        .inline-edit-input { width: 100%; padding: 4px; border: 1px solid #3b82f6; border-radius: 4px; outline: none; background: white; }

        .icon-btn { padding: 0.4rem; border-radius: 0.375rem; transition: background 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .icon-btn-edit { color: #3b82f6; }
        .icon-btn-edit:hover { background-color: #eff6ff; }
        .icon-btn-delete { color: #ef4444; }
        .icon-btn-delete:hover { background-color: #fef2f2; }

        /* Mindmap Canvas */
        #mindmapContainer { position: relative; width: 100%; height: 750px; background: #f1f5f9; border-radius: 0.75rem; border: 1px solid #e2e8f0; overflow: hidden; }
        
        @keyframes highlight {
            0% { background-color: #dbeafe; transform: scale(1.02); }
            100% { background-color: white; transform: scale(1); }
        }
        .highlight-target {
            animation: highlight 2s ease-out;
            border: 2px solid #3b82f6 !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Entity Manager <span class="text-blue-500 text-lg">v9.1</span></h1>
                <p class="text-slate-500">Zentrale Datenverwaltung mit Attribut-Sorting, Inline-Edit & Detail-Graph.</p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleConfigModal(true)" class="btn-ghost !border-slate-300 flex items-center gap-2 hover:bg-slate-50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><circle cx="12" cy="12" r="3" /></svg>
                    Typen & Felder
                </button>
                <div class="h-8 w-[1px] bg-slate-200 mx-2"></div>
                <div class="flex items-center gap-2">
                    <button onclick="triggerImport()" class="text-slate-500 hover:text-blue-600 transition-colors" title="Importieren">
                        <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    </button>
                    <button onclick="exportData()" class="text-slate-500 hover:text-blue-600 transition-colors" title="Exportieren">
                        <svg width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                    <input type="file" id="importInput" class="hidden" accept=".json" onchange="handleImport(event)">
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-slate-200 mb-6 overflow-x-auto whitespace-nowrap">
            <button onclick="switchTab('entities')" id="tab-entities" class="px-6 py-2 font-medium tab-active">Karten-Ansicht</button>
            <button onclick="switchTab('lists')" id="tab-lists" class="px-6 py-2 font-medium">Tabellen-Ansicht</button>
            <button onclick="switchTab('mindmap')" id="tab-mindmap" class="px-6 py-2 font-medium">Graph-Ansicht</button>
        </div>

        <!-- Section: Entities (Cards) -->
        <section id="section-entities" class="block">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6 h-fit">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800">Neuer Datensatz</h2>
                    <input type="hidden" id="editEntityId">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-slate-600">Typ</label>
                            <select id="entityTypeSelect" class="input-field" onchange="renderEntityFormFields()">
                                <option value="">-- w√§hlen --</option>
                            </select>
                        </div>
                        <div id="entityFormFields" class="space-y-4"></div>
                        <div class="flex gap-2">
                            <button id="saveEntityBtn" onclick="saveEntity()" class="btn-primary flex-1 justify-center hidden">Speichern</button>
                            <button id="cancelEntityBtn" onclick="resetEntityForm()" class="btn-ghost hidden">Abbrechen</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-4">
                    <div class="flex flex-col md:flex-row gap-4 bg-white p-4 rounded-xl border border-slate-200">
                        <div class="flex-1 relative">
                            <input type="text" id="entitySearch" class="input-field !mt-0 pl-10" placeholder="Suchen..." oninput="renderEntities()">
                            <svg class="absolute left-3 top-2.5 text-slate-400" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        </div>
                        <div id="typeFilters" class="flex flex-wrap gap-2 items-center"></div>
                    </div>
                    <div id="entityDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
            </div>
        </section>

        <!-- Section: List (Table) -->
        <section id="section-lists" class="hidden">
            <div class="card p-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                    <h2 class="text-xl font-semibold text-slate-800">Daten-Tabelle</h2>
                    <select id="listTypeSelect" class="input-field !mt-0 w-64" onchange="renderListView()">
                        <option value="">-- Typ w√§hlen --</option>
                    </select>
                </div>
                <div id="listTableContainer" class="table-container"></div>
                <div id="quickAddContainer" class="mt-4 hidden">
                    <h3 class="text-sm font-bold text-slate-400 uppercase mb-2">Schnell-Anlage</h3>
                    <div id="quickAddFields" class="flex flex-wrap gap-2 items-end"></div>
                </div>
            </div>
        </section>

        <!-- Section: Mindmap -->
        <section id="section-mindmap" class="hidden">
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-slate-800">Graph-Struktur</h2>
                    <button onclick="prepareMindmapData()" class="text-sm text-blue-600">Layout Reset</button>
                </div>
                <div id="mindmapContainer">
                    <canvas id="mindmapCanvas"></canvas>
                </div>
            </div>
        </section>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal">
        <div class="modal-content shadow-2xl">
            <button onclick="toggleConfigModal(false)" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <h2 class="text-2xl font-bold mb-6 border-b pb-4">Typen & Attribut-Reihenfolge</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-lg font-semibold mb-4">Typ definieren</h3>
                    <input type="hidden" id="editTypeId">
                    <div class="space-y-4">
                        <input type="text" id="typeName" class="input-field" placeholder="Typen-Name (z.B. Firma)">
                        <div id="attributeList" class="space-y-2"></div>
                        <button onclick="addAttributeRow()" class="text-sm text-blue-600 font-medium">+ Feld hinzuf√ºgen</button>
                        <button onclick="saveType()" class="btn-primary w-full justify-center">Typ Speichern</button>
                        <button id="cancelTypeBtn" onclick="resetTypeForm()" class="btn-ghost w-full hidden">Abbrechen</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Existierende Typen</h3>
                    <div id="typeDisplay" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="messageToast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transform translate-y-20 transition-transform duration-300 pointer-events-none z-[2000] text-sm"></div>

    <script>
        const ICON_EDIT = `<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>`;
        const ICON_DELETE = `<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
        const ICON_UP = `<svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M5 15l7-7 7 7"/></svg>`;
        const ICON_DOWN = `<svg width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M19 9l-7 7-7-7"/></svg>`;

        let appData = {
            types: [
                { id: 't1', name: 'Person', attributes: [{ name: 'Name', type: 'text' }, { name: 'Rolle', type: 'text' }] },
                { id: 't2', name: 'Projekt', attributes: [{ name: 'Titel', type: 'text' }, { name: 'Leiter', type: 'link', targetTypeId: 't1' }] }
            ],
            entities: [
                { id: 'e1', typeId: 't1', values: { 'Name': 'Max Mustermann', 'Rolle': 'Entwickler' } },
                { id: 'e2', typeId: 't2', values: { 'Titel': 'KI-Plattform', 'Leiter': 'e1' } }
            ]
        };
        let activeTypeFilters = new Set();
        let currentTab = 'entities';

        // --- Core Helpers ---
        function getBacklinks(entityId) {
            return appData.entities.filter(ent => {
                const type = appData.types.find(t => t.id === ent.typeId);
                return type.attributes.some(attr => attr.type === 'link' && ent.values[attr.name] === entityId);
            });
        }

        function getEntityLabel(id, withType = true) {
            const ent = appData.entities.find(e => e.id === id);
            if (!ent) return 'Unbekannt';
            const type = appData.types.find(t => t.id === ent.typeId);
            const nameAttr = type.attributes[0]?.name;
            const name = nameAttr ? ent.values[nameAttr] : ent.id;
            return withType ? `${type.name}: ${name}` : name;
        }

        // --- View Switching ---
        function switchTab(tab) {
            currentTab = tab;
            ['entities', 'lists', 'mindmap'].forEach(t => {
                document.getElementById('section-' + t).classList.toggle('hidden', t !== tab);
                document.getElementById('tab-' + t).classList.toggle('tab-active', t === tab);
            });
            refreshAllViews();
            if (tab === 'mindmap') initMindmap();
        }

        function toggleConfigModal(show) {
            document.getElementById('configModal').style.display = show ? 'flex' : 'none';
            if (show) renderTypes();
            else refreshAllViews();
        }

        // --- Type Configuration ---
        function addAttributeRow(name = '', type = 'text', target = '') {
            const container = document.getElementById('attributeList');
            const rowId = 'attr-' + Math.random().toString(36).substr(2, 9);
            const div = document.createElement('div');
            div.id = rowId;
            div.className = 'flex gap-2 items-center bg-white p-2 rounded border border-slate-200 attribute-row';
            div.innerHTML = `
                <div class="flex flex-col gap-1">
                    <button onclick="moveAttr('${rowId}', -1)" class="p-0.5 hover:bg-slate-100 rounded">${ICON_UP}</button>
                    <button onclick="moveAttr('${rowId}', 1)" class="p-0.5 hover:bg-slate-100 rounded">${ICON_DOWN}</button>
                </div>
                <input type="text" placeholder="Feldname" class="input-field !mt-0 text-sm flex-1 attr-name" value="${name}">
                <select class="input-field !mt-0 text-sm w-24 attr-type" onchange="toggleAttrTarget('${rowId}')">
                    <option value="text" ${type === 'text' ? 'selected' : ''}>Text</option>
                    <option value="link" ${type === 'link' ? 'selected' : ''}>Link</option>
                </select>
                <select class="input-field !mt-0 text-sm w-32 attr-target ${type === 'link' ? '' : 'hidden'}">
                    <option value="">Jeder Typ</option>
                    ${appData.types.map(t => `<option value="${t.id}" ${target === t.id ? 'selected' : ''}>-> ${t.name}</option>`).join('')}
                </select>
                <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 font-bold px-2">√ó</button>`;
            container.appendChild(div);
        }

        function moveAttr(rowId, dir) {
            const el = document.getElementById(rowId);
            if (dir === -1 && el.previousElementSibling) el.parentNode.insertBefore(el, el.previousElementSibling);
            if (dir === 1 && el.nextElementSibling) el.parentNode.insertBefore(el.nextElementSibling, el);
        }

        function toggleAttrTarget(id) {
            const row = document.getElementById(id);
            row.querySelector('.attr-target').classList.toggle('hidden', row.querySelector('.attr-type').value !== 'link');
        }

        function saveType() {
            const name = document.getElementById('typeName').value.trim();
            const editId = document.getElementById('editTypeId').value;
            if (!name) return;
            const attrs = [];
            document.querySelectorAll('.attribute-row').forEach(row => {
                const aName = row.querySelector('.attr-name').value;
                if (aName) attrs.push({ name: aName, type: row.querySelector('.attr-type').value, targetTypeId: row.querySelector('.attr-target').value });
            });
            if (editId) {
                const idx = appData.types.findIndex(t => t.id === editId);
                appData.types[idx] = { id: editId, name, attributes: attrs };
            } else {
                appData.types.push({ id: 't' + Date.now(), name, attributes: attrs });
            }
            resetTypeForm(); renderTypes(); showMessage("Typ aktualisiert");
        }

        function renderTypes() {
            document.getElementById('typeDisplay').innerHTML = appData.types.map(t => `
                <div class="card p-3 flex justify-between items-center border border-slate-100 hover:border-blue-200 cursor-pointer" onclick="editType('${t.id}')">
                    <div>
                        <div class="font-bold text-slate-800">${t.name}</div>
                        <div class="text-[10px] text-slate-400 uppercase">${t.attributes.length} Felder</div>
                    </div>
                    <button class="icon-btn icon-btn-edit">${ICON_EDIT}</button>
                </div>
            `).join('');
        }

        function editType(id) {
            const t = appData.types.find(x => x.id === id);
            document.getElementById('editTypeId').value = t.id;
            document.getElementById('typeName').value = t.name;
            document.getElementById('attributeList').innerHTML = '';
            t.attributes.forEach(a => addAttributeRow(a.name, a.type, a.targetTypeId));
            document.getElementById('cancelTypeBtn').classList.remove('hidden');
        }

        function resetTypeForm() {
            document.getElementById('editTypeId').value = ""; document.getElementById('typeName').value = "";
            document.getElementById('attributeList').innerHTML = ""; document.getElementById('cancelTypeBtn').classList.add('hidden');
        }

        // --- Entity Logic (Forms & Cards) ---
        function renderEntityFormFields(existing = null) {
            const typeId = document.getElementById('entityTypeSelect').value;
            const container = document.getElementById('entityFormFields');
            container.innerHTML = '';
            if (!typeId) { document.getElementById('saveEntityBtn').classList.add('hidden'); return; }
            const type = appData.types.find(t => t.id === typeId);
            type.attributes.forEach(a => {
                const val = existing ? existing[a.name] : '';
                let input = `<input type="text" class="input-field entity-val" data-attr="${a.name}" value="${val}">`;
                if (a.type === 'link') {
                    const targets = a.targetTypeId ? appData.entities.filter(e => e.typeId === a.targetTypeId) : appData.entities;
                    input = `<select class="input-field entity-val" data-attr="${a.name}">
                        <option value="">-- Link --</option>
                        ${targets.map(t => `<option value="${t.id}" ${val === t.id ? 'selected' : ''}>${getEntityLabel(t.id)}</option>`).join('')}
                    </select>`;
                }
                container.innerHTML += `<div><label class="text-[10px] uppercase font-bold text-slate-400">${a.name}</label>${input}</div>`;
            });
            document.getElementById('saveEntityBtn').classList.remove('hidden');
            document.getElementById('cancelEntityBtn').classList.remove('hidden');
        }

        function saveEntity() {
            const typeId = document.getElementById('entityTypeSelect').value, editId = document.getElementById('editEntityId').value;
            const values = {}; 
            document.querySelectorAll('#entityFormFields .entity-val').forEach(i => values[i.dataset.attr] = i.value);
            if (editId) {
                const idx = appData.entities.findIndex(e => e.id === editId);
                appData.entities[idx].values = values;
            } else {
                appData.entities.push({ id: 'e' + Date.now(), typeId, values });
            }
            resetEntityForm(); refreshAllViews(); showMessage("Datensatz gespeichert");
        }

        function resetEntityForm() {
            document.getElementById('editEntityId').value = ""; document.getElementById('entityTypeSelect').value = "";
            document.getElementById('entityTypeSelect').disabled = false; document.getElementById('entityFormFields').innerHTML = "";
            document.getElementById('saveEntityBtn').classList.add('hidden'); document.getElementById('cancelEntityBtn').classList.add('hidden');
        }

        function renderEntities() {
            const container = document.getElementById('entityDisplay'), search = document.getElementById('entitySearch').value.toLowerCase();
            container.innerHTML = '';
            appData.entities.filter(e => {
                const tMatches = activeTypeFilters.size === 0 || activeTypeFilters.has(e.typeId);
                const sMatches = Object.values(e.values).join(' ').toLowerCase().includes(search);
                return tMatches && sMatches;
            }).forEach(ent => {
                const type = appData.types.find(t => t.id === ent.typeId);
                const div = document.createElement('div');
                div.id = 'ent-card-' + ent.id; 
                div.className = 'card p-5 border-t-4 border-blue-500 hover:shadow-lg relative';
                
                const bLinks = getBacklinks(ent.id);
                let rows = '';
                type.attributes.forEach(a => {
                    let val = ent.values[a.name] || '-';
                    if (a.type === 'link' && val !== '-') {
                        val = `<button onclick="navigateToEntity('${val}')" class="text-blue-600 hover:underline">üîó ${getEntityLabel(val)}</button>`;
                    }
                    rows += `<div class="flex text-xs py-1 border-b border-slate-50"><span class="w-1/3 text-slate-400 font-bold uppercase text-[9px]">${a.name}</span><span class="w-2/3 truncate">${val}</span></div>`;
                });

                let blHtml = bLinks.length > 0 ? `<div class="mt-3 pt-2 border-t border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Verlinkt in:</p>
                    <div class="flex flex-wrap gap-1">${bLinks.map(bl => `<button onclick="navigateToEntity('${bl.id}')" class="text-[10px] bg-slate-100 hover:bg-slate-200 px-1.5 py-0.5 rounded text-slate-600">‚Üê ${getEntityLabel(bl.id)}</button>`).join('')}</div>
                </div>` : '';

                div.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-0.5 rounded">${type.name}</span>
                    <div class="flex gap-1"><button onclick="editEntity('${ent.id}')" class="icon-btn icon-btn-edit">${ICON_EDIT}</button><button onclick="deleteEntity('${ent.id}')" class="icon-btn icon-btn-delete">${ICON_DELETE}</button></div></div>
                    <div>${rows}${blHtml}</div>`;
                container.appendChild(div);
            });
        }

        // --- Table View (Inline-Edit & Quick-Add) ---
        function renderListView() {
            const typeId = document.getElementById('listTypeSelect').value, container = document.getElementById('listTableContainer');
            const quickAdd = document.getElementById('quickAddContainer');
            if (!typeId) { 
                container.innerHTML = '<p class="p-12 text-center text-slate-400 italic">W√§hlen Sie einen Typ aus, um die Tabelle zu laden.</p>'; 
                quickAdd.classList.add('hidden');
                return; 
            }
            const type = appData.types.find(t => t.id === typeId), ents = appData.entities.filter(e => e.typeId === typeId);
            quickAdd.classList.remove('hidden');
            
            let h = `<thead><tr>${type.attributes.map(a => `<th>${a.name}</th>`).join('')}<th>R√ºckverweise</th><th class="text-right">Aktion</th></tr></thead>`;
            
            let b = ents.map(e => {
                const cells = type.attributes.map(a => {
                    let val = e.values[a.name] || '';
                    let displayVal = val;
                    if (a.type === 'link' && val !== '') displayVal = 'üîó ' + getEntityLabel(val);
                    if (!displayVal) displayVal = '<span class="text-slate-300 italic">leer</span>';
                    return `<td class="cursor-pointer hover:bg-blue-50" onclick="startInlineEdit(this, '${e.id}', '${a.name}')">${displayVal}</td>`;
                }).join('');
                const bl = getBacklinks(e.id);
                const blHtml = `<td><div class="flex flex-wrap gap-1">${bl.map(b => `<span class="text-[10px] bg-slate-100 px-1 py-0.5 rounded">${getEntityLabel(b.id)}</span>`).join('')}</div></td>`;
                return `<tr>${cells}${blHtml}<td class="text-right"><button onclick="deleteEntity('${e.id}')" class="icon-btn icon-btn-delete">${ICON_DELETE}</button></td></tr>`;
            }).join('');
            
            container.innerHTML = `<table class="min-w-full">${h}<tbody>${b}</tbody></table>`;

            const qFields = document.getElementById('quickAddFields');
            qFields.innerHTML = type.attributes.map(a => {
                if (a.type === 'link') {
                    const targets = a.targetTypeId ? appData.entities.filter(e => e.typeId === a.targetTypeId) : appData.entities;
                    return `<div class="flex-1"><label class="text-[9px] font-bold text-slate-400 uppercase">${a.name}</label>
                        <select id="qa-${a.name}" class="input-field !mt-0 text-sm">
                            <option value="">-- w√§hlen --</option>
                            ${targets.map(t => `<option value="${t.id}">${getEntityLabel(t.id)}</option>`).join('')}
                        </select></div>`;
                }
                return `<div class="flex-1"><label class="text-[9px] font-bold text-slate-400 uppercase">${a.name}</label>
                    <input type="text" id="qa-${a.name}" class="input-field !mt-0 text-sm" placeholder="${a.name}..."></div>`;
            }).join('') + `<button onclick="quickAddEntity()" class="btn-primary">Hinzuf√ºgen</button>`;
        }

        function startInlineEdit(td, entId, attrName) {
            if (td.querySelector('input') || td.querySelector('select')) return;
            const ent = appData.entities.find(e => e.id === entId);
            const type = appData.types.find(t => t.id === ent.typeId);
            const attr = type.attributes.find(a => a.name === attrName);
            const val = ent.values[attrName] || '';

            let input;
            if (attr.type === 'link') {
                const targets = attr.targetTypeId ? appData.entities.filter(e => e.typeId === attr.targetTypeId) : appData.entities;
                input = document.createElement('select');
                input.className = 'inline-edit-input';
                input.innerHTML = `<option value="">-- w√§hlen --</option>` + targets.map(t => `<option value="${t.id}" ${val === t.id ? 'selected' : ''}>${getEntityLabel(t.id)}</option>`).join('');
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'inline-edit-input';
                input.value = val;
            }

            td.innerHTML = '';
            td.appendChild(input);
            input.focus();

            const finish = () => {
                const newVal = input.value;
                ent.values[attrName] = newVal;
                renderListView();
            };

            input.onblur = finish;
            input.onkeydown = (e) => { if (e.key === 'Enter') finish(); if (e.key === 'Escape') renderListView(); };
        }

        function quickAddEntity() {
            const typeId = document.getElementById('listTypeSelect').value;
            const type = appData.types.find(t => t.id === typeId);
            const values = {};
            type.attributes.forEach(a => { values[a.name] = document.getElementById(`qa-${a.name}`).value; });
            appData.entities.push({ id: 'e' + Date.now(), typeId, values });
            renderListView();
            showMessage("Datensatz in Tabelle angelegt");
        }

        // --- Helpers ---
        function navigateToEntity(id) {
            switchTab('entities');
            setTimeout(() => {
                const el = document.getElementById('ent-card-' + id);
                if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.classList.add('highlight-target'); setTimeout(() => el.classList.remove('highlight-target'), 2000); }
            }, 100);
        }

        function deleteEntity(id) { if (confirm("L√∂schen?")) { appData.entities = appData.entities.filter(e => e.id !== id); refreshAllViews(); } }

        function editEntity(id) {
            const ent = appData.entities.find(e => e.id === id);
            document.getElementById('editEntityId').value = ent.id;
            document.getElementById('entityTypeSelect').value = ent.typeId;
            document.getElementById('entityTypeSelect').disabled = true;
            renderEntityFormFields(ent.values); window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateTypeSelects() {
            ['entityTypeSelect', 'listTypeSelect'].forEach(id => {
                const s = document.getElementById(id); const cur = s.value;
                s.innerHTML = '<option value="">-- w√§hlen --</option>';
                appData.types.forEach(t => s.innerHTML += `<option value="${t.id}">${t.name}</option>`);
                s.value = cur;
            });
        }

        function updateTypeFilterUI() {
            document.getElementById('typeFilters').innerHTML = appData.types.map(t => `<div class="filter-tag px-3 py-1 rounded-full text-[10px] uppercase font-bold ${activeTypeFilters.has(t.id) ? 'active' : 'bg-slate-100 text-slate-500'}" onclick="toggleFilter('${t.id}')">${t.name}</div>`).join('');
        }

        function toggleFilter(id) { activeTypeFilters.has(id) ? activeTypeFilters.delete(id) : activeTypeFilters.add(id); updateTypeFilterUI(); renderEntities(); }

        function showMessage(text) {
            const toast = document.getElementById('messageToast');
            toast.innerText = text; toast.classList.remove('translate-y-20');
            setTimeout(() => toast.classList.add('translate-y-20'), 2500);
        }

        function triggerImport() { document.getElementById('importInput').click(); }
        function handleImport(ev) {
            const file = ev.target.files[0]; if (!file) return;
            const r = new FileReader(); r.onload = e => {
                try { const imp = JSON.parse(e.target.result); if(imp.types && imp.entities) { appData = imp; refreshAllViews(); showMessage("Import OK"); } } catch(err) { showMessage("Fehler!"); }
            }; r.readAsText(file);
        }
        function exportData() {
            const b = new Blob([JSON.stringify(appData, null, 2)], {type: 'application/json'});
            const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'entities.json'; a.click();
        }

        function refreshAllViews() {
            updateTypeSelects(); updateTypeFilterUI(); 
            if (currentTab === 'entities') renderEntities();
            if (currentTab === 'lists') renderListView();
        }

        // --- Graph Logic (WITH ATTRIBUTES) ---
        let nodes = [], links = [], canvas, ctx, animationId, draggedNode = null;
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

        function initMindmap() {
            canvas = document.getElementById('mindmapCanvas');
            ctx = canvas.getContext('2d');
            const container = document.getElementById('mindmapContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            canvas.onmousedown = handleMouseDown;
            window.onmousemove = handleMouseMove;
            window.onmouseup = handleMouseUp;
            prepareMindmapData();
            startSimulation();
        }

        function prepareMindmapData() {
            nodes = appData.entities.map(ent => {
                const type = appData.types.find(t => t.id === ent.typeId);
                const typeIdx = appData.types.findIndex(t => t.id === ent.typeId);
                
                // Extrahiere Attribute f√ºr die Anzeige im Graphen
                const attrStrings = type.attributes.map(attr => {
                    const val = ent.values[attr.name];
                    if (!val) return null;
                    const displayVal = attr.type === 'link' ? getEntityLabel(val, false) : val;
                    return `${attr.name}: ${displayVal}`;
                }).filter(s => s !== null);

                return {
                    id: ent.id,
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: 0, vy: 0, 
                    label: getEntityLabel(ent.id, false),
                    type: type.name,
                    attributes: attrStrings,
                    color: colors[typeIdx % colors.length]
                };
            });
            links = [];
            appData.entities.forEach(ent => {
                const type = appData.types.find(t => t.id === ent.typeId);
                type.attributes.forEach(attr => {
                    if (attr.type === 'link' && ent.values[attr.name]) {
                        links.push({ source: ent.id, target: ent.values[attr.name] });
                    }
                });
            });
        }

        function startSimulation() {
            if (animationId) cancelAnimationFrame(animationId);
            const step = () => { updatePhysics(); drawMindmap(); animationId = requestAnimationFrame(step); };
            step();
        }

        function updatePhysics() {
            const kRep = 3000, kSpring = 0.02, friction = 0.85, centerF = 0.003;
            nodes.forEach((n1, i) => {
                nodes.forEach((n2, j) => {
                    if (i === j) return;
                    let dx = n2.x - n1.x, dy = n2.y - n1.y, distSq = dx*dx + dy*dy || 1;
                    let force = kRep / distSq;
                    n1.vx -= (dx / Math.sqrt(distSq)) * force; n1.vy -= (dy / Math.sqrt(distSq)) * force;
                });
            });
            links.forEach(l => {
                let s = nodes.find(n => n.id === l.source), t = nodes.find(n => n.id === l.target);
                if (!s || !t) return;
                let dx = t.x - s.x, dy = t.y - s.y, dist = Math.sqrt(dx*dx + dy*dy) || 1;
                let force = (dist - 180) * kSpring;
                s.vx += (dx / dist) * force; s.vy += (dy / dist) * force;
                t.vx -= (dx / dist) * force; t.vy -= (dy / dist) * force;
            });
            nodes.forEach(n => {
                if (n === draggedNode) return;
                n.vx += (canvas.width/2 - n.x) * centerF; n.vy += (canvas.height/2 - n.y) * centerF;
                n.x += n.vx; n.y += n.vy; n.vx *= friction; n.vy *= friction;
            });
        }

        function drawMindmap() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            links.forEach(l => {
                let s = nodes.find(n => n.id === l.source), t = nodes.find(n => n.id === l.target);
                if (!s || !t) return;
                ctx.beginPath(); ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1;
                ctx.moveTo(s.x, s.y); ctx.lineTo(t.x, t.y); ctx.stroke();
            });
            nodes.forEach(n => {
                // Node Circle
                ctx.beginPath(); ctx.fillStyle = n.color; ctx.shadowBlur = 4; ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.arc(n.x, n.y, 10, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0;
                
                // Label (Name)
                ctx.fillStyle = '#1e293b'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(n.label, n.x, n.y - 20);
                
                // Type Tag
                ctx.fillStyle = n.color; ctx.font = '8px sans-serif';
                ctx.fillText(n.type.toUpperCase(), n.x, n.y - 35);

                // Attributes List
                ctx.fillStyle = '#64748b'; ctx.font = '9px sans-serif';
                n.attributes.forEach((attr, idx) => {
                    ctx.fillText(attr, n.x, n.y + 25 + (idx * 12));
                });
            });
        }

        function handleMouseDown(e) {
            const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left, y = e.clientY - r.top;
            draggedNode = nodes.find(n => Math.sqrt((x-n.x)**2 + (y-n.y)**2) < 30) || null;
        }
        function handleMouseMove(e) { if (draggedNode) { const r = canvas.getBoundingClientRect(); draggedNode.x = e.clientX - r.left; draggedNode.y = e.clientY - r.top; } }
        function handleMouseUp() { draggedNode = null; }

        window.onload = () => refreshAllViews();
    </script>
</body>
</html>
